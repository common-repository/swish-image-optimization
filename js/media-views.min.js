!function(e){if(void 0!=wp.media){var t=wp.media.controller.Library,i=wp.media.controller.FeaturedImage,a=wp.media.view.l10n,r=wp.media.view.MediaFrame.Select;wp.media.view.MediaFrame.Select=r.extend({initialize:function(){r.prototype.initialize.apply(this,arguments)},bindHandlers:function(){r.prototype.bindHandlers.apply(this,arguments),this.on("content:create:external",this.externalContent,this)},browseRouter:function(e){r.prototype.browseRouter.apply(this,arguments),e.set({external:{text:"External Media Library",priority:60}})},browseContent:function(e){var t=this.state();this.$el.removeClass("mode-external").addClass("mode-browse"),this.$el.removeClass("hide-toolbar"),e.view=new wp.media.view.AttachmentsBrowser({controller:this,collection:t.get("library"),selection:t.get("selection"),model:t,sortable:t.get("sortable"),search:t.get("searchable"),filters:t.get("filterable"),date:t.get("date"),display:t.has("display")?t.get("display"):t.get("displaySettings"),dragInfo:t.get("dragInfo"),idealColumnWidth:t.get("idealColumnWidth"),suggestedWidth:t.get("suggestedWidth"),suggestedHeight:t.get("suggestedHeight"),AttachmentView:t.get("AttachmentView")})},externalContent:function(e){var t=this.state();this.$el.removeClass("mode-browse").addClass("mode-external");var i=this.options;this.$el.removeClass("hide-toolbar"),e.view=new wp.media.view.AttachmentsBrowser({controller:this,collection:wp.media.externalquery(_.defaults({isExternal:!0,orderby:"menuOrder",order:"ASC"},i.library)),selection:t.get("selection"),model:t,sortable:t.get("sortable"),search:t.get("searchable"),filters:t.get("filterable"),date:t.get("date"),display:t.has("display")?t.get("display"):t.get("displaySettings"),dragInfo:t.get("dragInfo"),idealColumnWidth:t.get("idealColumnWidth"),suggestedWidth:t.get("suggestedWidth"),suggestedHeight:t.get("suggestedHeight"),AttachmentView:t.get("AttachmentView")})}}),wp.media.controller.ExternalLibrary=t.extend({defaults:{id:"insert",multiple:"add",describe:!1,toolbar:"select",sidebar:"settings",content:"upload",router:"browse",menu:"default",date:!1,external:!0,searchable:!0,filterable:!1,sortable:!1,autoSelect:!0,allowLocalEdits:!0,contentUserSetting:!0,syncSelection:!0}});var s,o=wp.media.view.MediaFrame.Post;wp.media.view.MediaFrame.Post=o.extend({initialize:function(){o.prototype.initialize.apply(this,arguments)},createStates:function(){o.prototype.createStates.apply(this,arguments);var e=this.options;this.states.remove({id:"insert"}),this.states.add([new wp.media.controller.ExternalLibrary({id:"insert",title:a.insertMediaTitle,priority:30,toolbar:"main-insert",filterable:"all",library:wp.media.query(e.library),multiple:!!e.multiple&&"reset",editable:!0,allowLocalEdits:!0,displaySettings:!0,displayUserSettings:!0,AttachmentView:wp.media.view.Attachment.Library})])},bindHandlers:function(){o.prototype.bindHandlers.apply(this,arguments),this.on("content:create:external",this.externalContent,this)},browseRouter:function(e){o.prototype.browseRouter.apply(this,arguments),e.set({external:{text:"External Media Library",priority:60}})},browseContent:function(e){var t=this.state();this.$el.removeClass("mode-external").addClass("mode-browse"),this.$el.removeClass("hide-toolbar"),e.view=new wp.media.view.AttachmentsBrowser({controller:this,collection:t.get("library"),selection:t.get("selection"),model:t,sortable:t.get("sortable"),search:t.get("searchable"),filters:t.get("filterable"),date:t.get("date"),display:t.has("display")?t.get("display"):t.get("displaySettings"),dragInfo:t.get("dragInfo"),idealColumnWidth:t.get("idealColumnWidth"),suggestedWidth:t.get("suggestedWidth"),suggestedHeight:t.get("suggestedHeight"),AttachmentView:t.get("AttachmentView")})},externalContent:function(e){var t=this.state();this.$el.removeClass("mode-browse").addClass("mode-external");var i=this.options;this.$el.removeClass("hide-toolbar"),e.view=new wp.media.view.AttachmentsBrowser({controller:this,collection:wp.media.externalquery(_.defaults({isExternal:!0,orderby:"menuOrder",order:"ASC"},i.library)),selection:t.get("selection"),model:t,sortable:t.get("sortable"),search:t.get("searchable"),filters:t.get("filterable"),date:t.get("date"),display:t.has("display")?t.get("display"):t.get("displaySettings"),dragInfo:t.get("dragInfo"),idealColumnWidth:t.get("idealColumnWidth"),suggestedWidth:t.get("suggestedWidth"),suggestedHeight:t.get("suggestedHeight"),AttachmentView:t.get("AttachmentView")})},mainInsertToolbar:function(t){o.prototype.mainInsertToolbar.apply(this,arguments);var i=this;this.selectionStatusToolbar(t),t.set("insertOptimised",{style:"primary",priority:80,text:a.sioExternalLibrary.insertOptimisedImageIntoPost,requires:{selection:!0},click:function(){var t=i.state(),a=t.get("selection"),r=[];a.forEach(function(e){r.push(e.get("id"))}),e(".media-button-insertOptimised").html("Processing..."),wp.media.ajax({data:{action:"sio-upload-to-ftp",selected:r}}).done(function(r){e(".media-modal.wp-core-ui").removeClass("loading"),i.close(),a.each(function(e,t){e.set("id",r[t])}),t.trigger("insert",a).reset()})}})}}),wp.media.controller.OptimisedFeaturedImage=i.extend({defaults:_.defaults({id:"optimised-featured-image",title:"Optimised Featured Image",multiple:!1,filterable:"uploaded",toolbar:"optimised-featured-image",priority:60,syncSelection:!0},t.prototype.defaults),initialize:function(){i.prototype.initialize.apply(this,arguments)},activate:function(){i.prototype.activate.apply(this,arguments)},deactivate:function(){i.prototype.deactivate.apply(this,arguments)},updateSelection:function(){i.prototype.updateSelection.apply(this,arguments)}}),wp.media.externalquery=function(e){return new wp.media.model.ExternalAttachments(null,{props:_.extend(_.defaults(e||{},{orderby:"date"}),{query:!0})})},wp.media.model.ExternalAttachments=wp.media.model.Attachments.extend({initialize:function(){wp.media.model.Attachments.prototype.initialize.apply(this,arguments)},_requery:function(e){this.props.get("query")&&(this.props.toJSON().cache=!1,this.mirror(wp.media.model.ExternalQuery.get(this.props.toJSON())))}}),wp.media.model.ExternalQuery=wp.media.model.Query.extend({initialize:function(){wp.media.model.Query.prototype.initialize.apply(this,arguments)},sync:function(e,t,i){return"read"===e?((i=i||{}).context=this,i.data=_.extend(i.data||{},{action:"query-external-attachments",post_id:wp.media.model.settings.post.id}),args=_.clone(this.args),-1!==args.posts_per_page&&(args.paged=Math.floor(this.length/args.posts_per_page)+1),i.data.query=args,wp.media.ajax(i)):(wp.media.model.Attachments.prototype.sync?wp.media.model.Attachments.prototype:Backbone).sync.apply(this,arguments)}},{get:(s=[],function(e,t){var i,a={},r=wp.media.model.ExternalQuery.orderby,o=wp.media.model.ExternalQuery.defaultProps,d=e.cache;return delete e.query,delete e.remotefilters,delete e.uioptions,_.defaults(e,o),e.order=e.order.toUpperCase(),"DESC"!==e.order&&"ASC"!==e.order&&(e.order=o.order.toUpperCase()),_.contains(r.allowed,e.orderby)||(e.orderby=o.orderby),_.each(e,function(e,t){_.isNull(e)||(a[wp.media.model.ExternalQuery.propmap[t]||t]=e)}),_.defaults(a,wp.media.model.ExternalQuery.defaultArgs),a.orderby=r.valuemap[e.orderby]||e.orderby,d?i=_.find(s,function(e){return _.isEqual(e.args,a)}):s=[],i||(i=new wp.media.model.ExternalQuery([],_.extend(t||{},{props:e,args:a})),s.push(i)),i})}),wp.media.optimisedFeaturedImage={get:function(){return wp.media.view.settings.post.featuredImageId},set:function(t){var i=wp.media.view.settings;i.post.featuredImageId=t,e("#postimagediv .loading").removeClass("hidden"),wp.media.post("sio-upload-to-ftp",{post_id:i.post.id,selected:i.post.featuredImageId,_wpnonce:i.post.nonce}).done(function(t){wp.media.post("get-post-thumbnail-html",{post_id:i.post.id,thumbnail_id:t[0],_wpnonce:i.post.nonce}).done(function(t){"0"!=t?(e(".inside","#postimagediv").html(t),e("#postimagediv .loading").addClass("hidden")):window.alert(window.setPostThumbnailL10n.error)})})},remove:function(){wp.media.optimisedFeaturedImage.set(-1)},frame:function(){return this._frame?(wp.media.frame=this._frame,this._frame):(this._frame=wp.media({state:"optimised-featured-image",states:[new wp.media.controller.OptimisedFeaturedImage,new wp.media.controller.EditImage]}),this._frame.on("toolbar:create:optimised-featured-image",function(e){this.createSelectToolbar(e,{text:"Set optimised featured image"})},this._frame),this._frame.on("content:render:edit-image",function(){var e=this.state("optimised-featured-image").get("selection"),t=new wp.media.view.EditImage({model:e.single(),controller:this}).render();this.content.set(t),t.loadEditor()},this._frame),this._frame.state("optimised-featured-image").on("select",this.select),this._frame)},select:function(){var e=this.get("selection").single();wp.media.view.settings.post.featuredImageId&&wp.media.optimisedFeaturedImage.set(e?e.id:-1)},init:function(){e("#postimagediv").append('<div class="loading hidden"></div>'),e("#postimagediv").on("click","#set-optimised-post-thumbnail",function(e){e.preventDefault(),e.stopPropagation(),wp.media.optimisedFeaturedImage.frame().open()})}},e(wp.media.optimisedFeaturedImage.init)}}(jQuery);